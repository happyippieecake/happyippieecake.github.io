name: Deploy PHP Native to cPanel

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_upload:
        description: 'Force upload all PHP files'
        required: false
        default: 'false'
        type: choice
        options:
        - 'false'
        - 'true'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Determine Deployment Type
      id: deploy_mode
      run: |
        if [[ "${{ github.event.inputs.force_upload }}" == "true" ]]; then
          echo "deployment_type=force_all_php" >> $GITHUB_OUTPUT
        elif [[ $(git diff --name-only HEAD~1 HEAD | grep -E '\.(php|html|css|js)$' | wc -l) -gt 5 ]]; then
          echo "deployment_type=full" >> $GITHUB_OUTPUT
        else
          echo "deployment_type=smart" >> $GITHUB_OUTPUT
        fi

    - name: Smart Server Sync
      id: smart_deploy
      if: steps.deploy_mode.outputs.deployment_type == 'smart'
      uses: nick-fields/retry@v2
      with:
        timeout_minutes: 10
        max_attempts: 3
        retry_wait_seconds: 20
        command: |
          sudo apt-get update && sudo apt-get install -y lftp
          lftp -e "
          set ftp:ssl-allow no;
          open ${{ secrets.SERVER }};
          user ${{ secrets.USERNAME }} ${{ secrets.PASSWORD }};
          lcd ./;

          echo 'üöÄ Starting Happieecake deployment...';
          echo 'üïí Timestamp:' \$(date);

          # Backup db_connect.php
          echo 'üì¶ Backing up db_connect.php (if exists)...';
          get db_connect.php db_connect_backup.php || echo '‚ö†Ô∏è db_connect.php not found on server';

          # Remove old files except db_connect.php
          echo 'üßπ Cleaning up old files (except db_connect.php)...';
          mrm *.php || echo 'No PHP files to remove';
          mrm *.html || echo 'No HTML files to remove';
          mrm *.css || echo 'No CSS files to remove';
          mrm *.js || echo 'No JS files to remove';
          mrm *.ico *.png *.jpg *.jpeg *.gif || echo 'No image files to remove';
          mrm .htaccess || echo 'No .htaccess to remove';
          mrm database.sql || echo 'No database.sql to remove';
          rm -rf Gambar || echo 'No Gambar folder to remove';

          # Restore db_connect.php
          echo '‚ôªÔ∏è Restoring db_connect.php...';
          put db_connect_backup.php db_connect.php || echo '‚ö†Ô∏è Could not restore db_connect.php';
          rm -f db_connect_backup.php || echo 'Cleanup of backup failed';

          # Upload files (individual mput)
          echo '‚¨ÜÔ∏è Uploading files...';
          mput *.php || echo 'No PHP files';
          mput *.html || echo 'No HTML files';
          mput *.css || echo 'No CSS files';
          mput *.js || echo 'No JS files';
          mput *.ico || echo 'No favicon';
          mput database.sql || echo 'No database.sql';
          put .htaccess || echo 'No .htaccess';

          # Upload folder Gambar
          echo 'üñº Uploading Gambar folder...';
          mirror --reverse --verbose --parallel=2 Gambar/ Gambar/ || echo 'No Gambar folder to upload';

          echo '‚úÖ Happieecake deployment complete.';
          quit
          "

    - name: Deployment Success
      if: success()
      run: |
        echo "‚úÖ Happieecake website sync completed!"
        echo "üßπ Website files updated on server"